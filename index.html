<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>On-Call Generator</title>
    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #020617;
        color: #e5e7eb;
      }
      .navbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1.5rem;
        background: #020617;
        border-bottom: 1px solid #111827;
        position: sticky;
        top: 0;
        z-index: 10;
      }
      .logo {
        font-weight: 700;
        color: #38bdf8;
      }
      .nav-links a {
        margin-left: 1rem;
        color: #e5e7eb;
        text-decoration: none;
        font-size: 0.9rem;
      }
      .nav-links a:hover {
        color: #38bdf8;
      }
      .container {
        max-width: 1100px;
        margin: 1.5rem auto;
        padding: 0 1rem 2rem;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
      }
      .card {
        background: #020617;
        border: 1px solid #111827;
        border-radius: 0.5rem;
        padding: 1rem;
        flex: 1 1 320px;
      }
      h2,
      h3 {
        margin-top: 0;
        color: #f9fafb;
      }
      label {
        display: block;
        font-size: 0.8rem;
        margin-bottom: 0.25rem;
        color: #9ca3af;
      }
      input,
      select {
        width: 100%;
        padding: 0.4rem 0.5rem;
        border-radius: 0.375rem;
        border: 1px solid #1f2937;
        background: #020617;
        color: #e5e7eb;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
      }
      button {
        padding: 0.4rem 0.8rem;
        border-radius: 0.375rem;
        border: none;
        font-size: 0.85rem;
        cursor: pointer;
      }
      .btn-primary {
        background: #38bdf8;
        color: #020617;
      }
      .btn-primary:hover {
        background: #0ea5e9;
      }
      .btn-secondary {
        background: #111827;
        color: #e5e7eb;
        border: 1px solid #1f2937;
      }
      .btn-secondary:hover {
        background: #1f2937;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
      }
      th,
      td {
        padding: 0.4rem 0.5rem;
        border-bottom: 1px solid #111827;
        text-align: left;
        vertical-align: top;
      }
      th {
        color: #9ca3af;
        font-weight: 500;
      }
      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
      }
      .badge {
        display: inline-block;
        padding: 0.1rem 0.35rem;
        border-radius: 999px;
        background: #111827;
        font-size: 0.7rem;
        color: #e5e7eb;
      }
      .date-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
      }
      .date-tag {
        padding: 0.05rem 0.3rem;
        border-radius: 999px;
        background: #0f172a;
        font-size: 0.7rem;
      }
      .radio-group {
        display: flex;
        gap: 1rem;
        margin: 0.25rem 0 0.75rem;
        font-size: 0.85rem;
        color: #d1d5db;
      }
      /* Modal */
      #modalOverlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 50;
      }
      .modal-box {
        background: #020617;
        border: 1px solid #111827;
        border-radius: 0.5rem;
        padding: 1rem;
        max-width: 420px;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="navbar">
      <div class="logo">On-Call Generator</div>
      <div class="nav-links">
        <a href="#home">Home</a>
        <a href="#data">Data</a>
      </div>
    </div>

    <div class="container" id="home">
      <!-- Home / Generator card -->
      <div class="card">
        <h2>Generate Schedule</h2>

        <label for="mondaySelect">Select Monday (next 4 weeks)</label>
        <select id="mondaySelect"></select>

        <label>Export type</label>
        <div class="radio-group">
          <label
            ><input type="radio" name="exportType" value="txt" checked /> Text
            file</label
          >
          <label
            ><input type="radio" name="exportType" value="ics" /> Outlook
            (.ics)</label
          >
        </div>

        <button class="btn-primary" id="generateBtn">Generate</button>
        <p
          id="status"
          style="font-size: 0.8rem; color: #9ca3af; margin-top: 0.5rem"
        ></p>

        <div
          style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap"
        >
          <button class="btn-secondary" id="exportBtn">Export data</button>
          <button class="btn-secondary" id="importBtn">Import data</button>
          <input
            type="file"
            id="importInput"
            style="display: none"
            accept="application/json"
          />
        </div>
      </div>

      <!-- Data card with tables -->
      <div class="card" id="data">
        <div class="section-header">
          <h3>Contacts</h3>
          <button class="btn-secondary" id="addContactBtn">Add contact</button>
        </div>
        <table id="contactsTable">
          <thead>
            <tr>
              <th>On-call / Name</th>
              <th>Team</th>
              <th>Phone</th>
              <th>Start dates</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="section-header" style="margin-top: 1rem">
          <h3>Emergency contacts</h3>
          <button class="btn-secondary" id="addEmergencyBtn">
            Add emergency
          </button>
        </div>
        <table id="emergencyTable">
          <thead>
            <tr>
              <th>On-call / Name</th>
              <th>Contact</th>
              <th>Email</th>
              <th>Start dates</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Modal -->
    <div id="modalOverlay">
      <div class="modal-box">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
          "
        >
          <h3
            id="modalTitle"
            style="margin: 0; color: #f9fafb; font-size: 1.1rem"
          >
            Edit
          </h3>
          <button id="closeModalBtn" class="btn-secondary">X</button>
        </div>

        <!-- Contact form -->
        <form id="contactForm" style="display: none">
          <input type="hidden" id="contactIndex" value="-1" />
          <label for="cName">Name</label>
          <input id="cName" type="text" />
          <label for="cPhone">Phone</label>
          <input id="cPhone" type="text" />
          <label for="cTeam">Team</label>
          <select id="cTeam">
            <option value="MBT Network/DataCenter">
              MBT Network/DataCenter
            </option>
            <option value="MBT Storage/VM">MBT Storage/VM</option>
            <option value="MBT Server/Citrix">MBT Server/Citrix</option>
            <option value="MBT Database (DB)">MBT Database (DB)</option>
          </select>
          <div style="margin-top: 0.75rem">
            <button type="submit" class="btn-primary">Save</button>
          </div>
        </form>

        <!-- Emergency form -->
        <form id="emergencyForm" style="display: none">
          <input type="hidden" id="emIndex" value="-1" />
          <label for="eName">Name</label>
          <input id="eName" type="text" />
          <label for="ePhone">Phone</label>
          <input id="ePhone" type="text" />
          <label for="eEmail">Email</label>
          <input id="eEmail" type="email" />
          <div style="margin-top: 0.75rem">
            <button type="submit" class="btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Data (start empty; load via Import, or edit in UI then Export)
        const contacts = [
          {
            name: "Muzaffer Gurkan Ozel",
            phone: "+90 532 059 63 63",
            team: "MBT Network/DataCenter",
            startDates: ["2025-12-08", "2025-12-29"],
          },
          {
            name: "Abdullah Isilar",
            phone: "+90 537 400 90 17",
            team: "MBT Storage/VM",
            startDates: ["2025-12-08", "2025-12-22"],
          },
          {
            name: "Tahir Evren Kiral",
            phone: "+90 549 549 04 40",
            team: "MBT Server/Citrix",
            startDates: ["2025-12-08", "2025-12-22"],
          },
          {
            name: "Burak Koc",
            phone: "+90 505 260 82 80",
            team: "MBT Database (DB)",
            startDates: [
              "2025-12-08",
              "2025-12-15",
              "2025-12-22",
              "2025-12-29",
            ],
          },
          {
            name: "Santhoshkumar Kalluri",
            phone: "+91 888 654 63 33",
            team: "MBT Database (DB)",
            startDates: [],
          },
          {
            name: "Bilal Oner",
            phone: "+90 533 211 72 11",
            team: "MBT Network/DataCenter",
            startDates: ["2025-12-15"],
          },
          {
            name: "Halit Naziroglu",
            phone: "+90 534 200 12 51",
            team: "MBT Network/DataCenter",
            startDates: ["2025-12-22"],
          },
          {
            name: "Mustafa Sari",
            phone: "+90 530 523 91 07",
            team: "MBT Storage/VM",
            startDates: ["2025-12-15", "2025-12-29"],
          },
          {
            name: "Ibrahim Ozer",
            phone: "+90 532 407 56 50",
            team: "MBT Server/Citrix",
            startDates: ["2025-12-15", "2025-12-29"],
          },
        ];
        const emergencyContacts = [
          {
            name: "Sercan Eren",
            phone: "+90 543 534 92 29",
            email: "-",
            startDates: ["2025-12-08"],
          },
          {
            name: "Onur Aydin",
            phone: "+ 90 530 940 53 84 / +90 532 552 71 61",
            email: "-",
            startDates: ["2025-12-29"],
          },
          {
            name: "Aykut Erdonmez",
            phone: "+90 538 276 92 36",
            email: "-",
            startDates: [],
          },
          {
            name: "Ayhan Ay",
            phone: "+90 536 308 18 01",
            email: "-",
            startDates: [],
          },
          {
            name: "Murat Buyukozer",
            phone: "+90 532 272 34 21",
            email: "-",
            startDates: [],
          },
          {
            name: "Mehmet Akif Acar",
            phone: "+00 000 000 00 00",
            email: "mehmet_akif.acar@daimler.com",
            startDates: ["2025-12-15"],
          },
          {
            name: "Cemal Olke",
            phone: "-",
            email: "cemal.olke@daimlertruck.com",
            startDates: ["2025-12-22"],
          },
        ];

        // Date helpers
        function getNextMondays(count = 4) {
          const mondays = [];
          const today = new Date();
          const date = new Date(
            today.getFullYear(),
            today.getMonth(),
            today.getDate()
          );
          const day = date.getDay();
          const diff = (1 - day + 7) % 7;
          date.setDate(date.getDate() + diff);
          for (let i = 0; i < count; i++) {
            const d = new Date(date);
            d.setDate(date.getDate() + i * 7);
            mondays.push(d);
          }
          return mondays;
        }

        function formatDate(d) {
          const year = d.getFullYear();
          const month = String(d.getMonth() + 1).padStart(2, "0");
          const day = String(d.getDate()).padStart(2, "0");
          return `${year}-${month}-${day}`;
        }

        function parseDate(str) {
          const [y, m, d] = str.split("-").map(Number);
          return new Date(y, m - 1, d);
        }

        function formatDDMMYYYY(d) {
          const day = String(d.getDate()).padStart(2, "0");
          const month = String(d.getMonth() + 1).padStart(2, "0");
          const year = d.getFullYear();
          return `${day}-${month}-${year}`;
        }

        // Monday select
        const mondaySelect = document.getElementById("mondaySelect");
        getNextMondays().forEach((d, idx) => {
          const opt = document.createElement("option");
          opt.value = formatDate(d);
          opt.textContent = d.toDateString();
          if (idx === 0) opt.selected = true;
          mondaySelect.appendChild(opt);
        });

        // Modal refs
        const modalOverlay = document.getElementById("modalOverlay");
        const modalTitle = document.getElementById("modalTitle");
        const contactFormEl = document.getElementById("contactForm");
        const emergencyFormEl = document.getElementById("emergencyForm");

        function openModal(type) {
          if (type === "contact") {
            modalTitle.textContent = "Contact";
            contactFormEl.style.display = "block";
            emergencyFormEl.style.display = "none";
          } else {
            modalTitle.textContent = "Emergency contact";
            contactFormEl.style.display = "none";
            emergencyFormEl.style.display = "block";
          }
          modalOverlay.style.display = "flex";
        }

        function closeModal() {
          modalOverlay.style.display = "none";
        }

        document
          .getElementById("closeModalBtn")
          .addEventListener("click", closeModal);
        modalOverlay.addEventListener("click", (e) => {
          if (e.target === modalOverlay) closeModal();
        });

        // Render tables with weekly on-call checkboxes
        function renderContacts() {
          const tbody = document.querySelector("#contactsTable tbody");
          const monday = mondaySelect.value;
          tbody.innerHTML = "";
          contacts.forEach((c, index) => {
            const isOnCall =
              Array.isArray(c.startDates) && c.startDates.includes(monday);
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>
                <label>
                  <input type="checkbox" class="contact-oncall" data-index="${index}" ${
              isOnCall ? "checked" : ""
            }>
                  ${c.name || ""}
                </label>
              </td>
              <td><span class="badge">${c.team || ""}</span></td>
              <td>${c.phone || ""}</td>
              <td>
                <div class="date-tags">
                  ${(c.startDates || [])
                    .map((d) => `<span class="date-tag">${d}</span>`)
                    .join("")}
                </div>
              </td>
              <td>
                <button class="btn-secondary" data-type="contact" data-index="${index}">Edit</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }

        function renderEmergency() {
          const tbody = document.querySelector("#emergencyTable tbody");
          const monday = mondaySelect.value;
          tbody.innerHTML = "";
          emergencyContacts.forEach((c, index) => {
            const isOnCall =
              Array.isArray(c.startDates) && c.startDates.includes(monday);
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>
                <label>
                  <input type="checkbox" class="emergency-oncall" data-index="${index}" ${
              isOnCall ? "checked" : ""
            }>
                  ${c.name || ""}
                </label>
              </td>
              <td>${c.phone || ""}</td>
              <td>${c.email || ""}</td>
              <td>
                <div class="date-tags">
                  ${(c.startDates || [])
                    .map((d) => `<span class="date-tag">${d}</span>`)
                    .join("")}
                </div>
              </td>
              <td>
                <button class="btn-secondary" data-type="emergency" data-index="${index}">Edit</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }

        renderContacts();
        renderEmergency();

        mondaySelect.addEventListener("change", () => {
          renderContacts();
          renderEmergency();
        });

        // Add buttons
        document
          .getElementById("addContactBtn")
          .addEventListener("click", () => {
            document.getElementById("contactIndex").value = -1;
            document.getElementById("cName").value = "";
            document.getElementById("cPhone").value = "";
            document.getElementById("cTeam").value = "MBT Network/DataCenter";
            openModal("contact");
          });

        document
          .getElementById("addEmergencyBtn")
          .addEventListener("click", () => {
            document.getElementById("emIndex").value = -1;
            document.getElementById("eName").value = "";
            document.getElementById("ePhone").value = "";
            document.getElementById("eEmail").value = "";
            openModal("emergency");
          });

        // Edit buttons
        document
          .querySelector("#contactsTable tbody")
          .addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
              const idx = parseInt(e.target.dataset.index, 10);
              const c = contacts[idx];
              document.getElementById("contactIndex").value = idx;
              document.getElementById("cName").value = c.name || "";
              document.getElementById("cPhone").value = c.phone || "";
              document.getElementById("cTeam").value =
                c.team || "MBT Network/DataCenter";
              openModal("contact");
            }
          });

        document
          .querySelector("#emergencyTable tbody")
          .addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") {
              const idx = parseInt(e.target.dataset.index, 10);
              const c = emergencyContacts[idx];
              document.getElementById("emIndex").value = idx;
              document.getElementById("eName").value = c.name || "";
              document.getElementById("ePhone").value = c.phone || "";
              document.getElementById("eEmail").value = c.email || "";
              openModal("emergency");
            }
          });

        // Save handlers (no date editing here)
        document
          .getElementById("contactForm")
          .addEventListener("submit", (e) => {
            e.preventDefault();
            const index = parseInt(
              document.getElementById("contactIndex").value,
              10
            );
            const name = document.getElementById("cName").value.trim();
            const phone = document.getElementById("cPhone").value.trim();
            const team = document.getElementById("cTeam").value;
            if (!name) return;
            const existing =
              index === -1 ? { startDates: [] } : contacts[index];
            const obj = {
              name,
              phone,
              team,
              startDates: existing.startDates || [],
            };
            if (index === -1) contacts.push(obj);
            else contacts[index] = obj;
            renderContacts();
            closeModal();
          });

        document
          .getElementById("emergencyForm")
          .addEventListener("submit", (e) => {
            e.preventDefault();
            const index = parseInt(
              document.getElementById("emIndex").value,
              10
            );
            const name = document.getElementById("eName").value.trim();
            const phone = document.getElementById("ePhone").value.trim();
            const email = document.getElementById("eEmail").value.trim();
            if (!name) return;
            const existing =
              index === -1 ? { startDates: [] } : emergencyContacts[index];
            const obj = {
              name,
              phone,
              email,
              startDates: existing.startDates || [],
            };
            if (index === -1) emergencyContacts.push(obj);
            else emergencyContacts[index] = obj;
            renderEmergency();
            closeModal();
          });

        // Update startDates from weekly checkboxes
        function updateStartDatesFromCheckboxes(monday) {
          document.querySelectorAll(".contact-oncall").forEach((cb) => {
            const idx = parseInt(cb.dataset.index, 10);
            const c = contacts[idx];
            if (!Array.isArray(c.startDates)) c.startDates = [];
            const has = c.startDates.includes(monday);
            if (cb.checked && !has) c.startDates.push(monday);
            if (!cb.checked && has) {
              c.startDates = c.startDates.filter((d) => d !== monday);
            }
          });
          document.querySelectorAll(".emergency-oncall").forEach((cb) => {
            const idx = parseInt(cb.dataset.index, 10);
            const c = emergencyContacts[idx];
            if (!Array.isArray(c.startDates)) c.startDates = [];
            const has = c.startDates.includes(monday);
            if (cb.checked && !has) c.startDates.push(monday);
            if (!cb.checked && has) {
              c.startDates = c.startDates.filter((d) => d !== monday);
            }
          });
        }

        // Text for Monday
        function buildTextScheduleForMonday(mondayStr) {
          const monday = parseDate(mondayStr);
          const nextMonday = new Date(monday);
          nextMonday.setDate(monday.getDate() + 7);
          const startStr = formatDDMMYYYY(monday) + " (17:15) CET";
          const endStr = formatDDMMYYYY(nextMonday) + " (07:30) CET";

          const activeContacts = contacts.filter(
            (c) =>
              Array.isArray(c.startDates) && c.startDates.includes(mondayStr)
          );

          const activeEmergencies = emergencyContacts.filter(
            (c) =>
              Array.isArray(c.startDates) && c.startDates.includes(mondayStr)
          );

          const lines = [];
          lines.push("Hello Service Desk,");
          lines.push(
            "Please find the updated On-Call Support for MB Turkey Wintel Monitoring Services in your calendar."
          );
          lines.push("");

          activeContacts.forEach((c, idx) => {
            lines.push("Service:      " + (c.team || ""));
            lines.push("Colleague:    " + (c.name || ""));
            lines.push("Start time:   " + startStr);
            lines.push("End time:     " + endStr);
            if (c.phone) lines.push("Phone:        " + c.phone);
            if (idx !== activeContacts.length - 1) lines.push("");
          });

          lines.push("");
          lines.push("Emergency Case First contact Daimler:");
          activeEmergencies.forEach((c) => {
            if (!c.phone && !c.email) return;
            lines.push(c.name || "");
            if (c.phone) lines.push(c.phone);
            if (c.email) lines.push(c.email);
          });

          return lines.join("\n");
        }

        // Download helper
        function downloadFile(filename, content, mime) {
          const blob = new Blob([content], { type: mime });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        }

        // ICS
        function buildIcs(startMonday) {
          const uid = Date.now() + "@oncall";
          const dt = startMonday.replace(/-/g, "");
          const ics =
            "BEGIN:VCALENDAR\n" +
            "VERSION:2.0\n" +
            "PRODID:-//OnCall//EN\n" +
            "CALSCALE:GREGORIAN\n" +
            "METHOD:PUBLISH\n" +
            "BEGIN:VEVENT\n" +
            "UID:" +
            uid +
            "\n" +
            "DTSTART;VALUE=DATE:" +
            dt +
            "\n" +
            "DTEND;VALUE=DATE:" +
            dt +
            "\n" +
            "SUMMARY:On-call schedule\n" +
            "DESCRIPTION:" +
            buildTextScheduleForMonday(startMonday).replace(/\n/g, "\\n") +
            "\n" +
            "END:VEVENT\n" +
            "END:VCALENDAR";
          return ics;
        }

        // Export / Import JSON
        function exportData() {
          const data = { contacts, emergencyContacts };
          const json = JSON.stringify(data, null, 2);
          downloadFile("oncall-data.json", json, "application/json");
        }

        function importData(file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const parsed = JSON.parse(e.target.result);
              if (
                Array.isArray(parsed.contacts) &&
                Array.isArray(parsed.emergencyContacts)
              ) {
                contacts.length = 0;
                contacts.push(...parsed.contacts);
                emergencyContacts.length = 0;
                emergencyContacts.push(...parsed.emergencyContacts);
                renderContacts();
                renderEmergency();
              } else {
                alert("Invalid file format.");
              }
            } catch {
              alert("Could not read file.");
            }
          };
          reader.readAsText(file);
        }

        document
          .getElementById("exportBtn")
          .addEventListener("click", exportData);
        document.getElementById("importBtn").addEventListener("click", () => {
          document.getElementById("importInput").click();
        });
        document
          .getElementById("importInput")
          .addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (file) importData(file);
          });

        // Generate
        document.getElementById("generateBtn").addEventListener("click", () => {
          const monday = mondaySelect.value;
          const exportType = document.querySelector(
            "input[name='exportType']:checked"
          ).value;
          const status = document.getElementById("status");
          if (!monday) {
            status.textContent = "Select a Monday first.";
            return;
          }

          // Sync checkboxes to startDates
          updateStartDatesFromCheckboxes(monday);
          renderContacts();
          renderEmergency();

          if (exportType === "txt") {
            const txt = buildTextScheduleForMonday(monday);
            downloadFile(
              "oncall-" + monday + ".txt",
              txt,
              "text/plain;charset=utf-8"
            );
            status.textContent = "Text file downloaded.";
          } else {
            const ics = buildIcs(monday);
            downloadFile(
              "oncall-" + monday + ".ics",
              ics,
              "text/calendar;charset=utf-8"
            );
            status.textContent = "ICS file downloaded.";
          }
        });
      });
    </script>
  </body>
</html>
